<div class="container mt-4">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-edit me-2"></i> Edit Announcement
                    </h5>
                </div>

                <div class="card-body">
                    <% if (locals.errors && errors.length > 0) { %>
                        <div class="alert alert-danger">
                            <ul class="mb-0">
                                <% errors.forEach(error => { %>
                                    <li><%= error.msg %></li>
                                <% }); %>
                            </ul>
                        </div>
                    <% } %>

                    <form action="/admin/announcements/edit/<%= announcement.announcement_id %>" method="POST">
                        <div class="mb-3">
                            <label for="title" class="form-label">Announcement Title</label>
                            <input type="text" class="form-control" id="title" name="title" 
                                value="<%= locals.formData ? formData.title : announcement.title %>" required>
                        </div>

                        <div class="mb-3">
                            <label for="content" class="form-label">Announcement Content</label>
                            <textarea class="form-control" id="content" name="content" rows="6" required><%= locals.formData ? formData.content : announcement.content %></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="target_type" class="form-label">Target Audience</label>
                            <select class="form-select" id="target_type" name="target_type" required>
                                <option value="">Select target audience</option>
                                <option value="all" <%= (locals.formData ? formData.target_type : announcement.target_type) === 'all' ? 'selected' : '' %>>All Users</option>
                                <option value="students" <%= (locals.formData ? formData.target_type : announcement.target_type) === 'students' ? 'selected' : '' %>>All Students</option>
                                <option value="instructors" <%= (locals.formData ? formData.target_type : announcement.target_type) === 'instructors' ? 'selected' : '' %>>All Instructors</option>
                                <option value="course" <%= (locals.formData ? formData.target_type : announcement.target_type) === 'course' ? 'selected' : '' %>>Specific Course</option>
                                <option value="specific_users" <%= (locals.formData ? formData.target_type : announcement.target_type) === 'specific_users' ? 'selected' : '' %>>Specific Users</option>
                            </select>
                        </div>

                        <div id="course-selection" class="mb-3" style="display: none;">
                            <label for="course_id" class="form-label">Select Course</label>
                            <select class="form-select" id="course_id" name="course_id">
                                <option value="">Select a course</option>
                                <% if (locals.courses && courses.length > 0) { %>
                                    <% courses.forEach(course => { %>
                                        <option value="<%= course.course_id %>" 
                                            <%= locals.formData ? 
                                                (formData.course_id == course.course_id ? 'selected' : '') : 
                                                (announcement.course_id == course.course_id ? 'selected' : '') %>>
                                            <%= course.course_code %> - <%= course.title %>
                                        </option>
                                    <% }); %>
                                <% } %>
                            </select>
                        </div>
                        
                        <div id="specific-users-selection" class="mb-3" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Select Students</h6>
                                        </div>
                                        <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                            <div class="mb-2">
                                                <input type="text" class="form-control form-control-sm" id="studentSearch" placeholder="Search students...">
                                            </div>
                                            <div class="student-list">
                                                <% if (locals.students && students.length > 0) { %>
                                                    <% students.forEach(student => { %>
                                                        <div class="form-check student-item">
                                                            <input class="form-check-input student-checkbox" type="checkbox" 
                                                                name="specific_users" value="<%= student.user_id %>" 
                                                                id="student-<%= student.user_id %>"
                                                                <% if (locals.formData && formData.specific_users) { %>
                                                                    <%= (Array.isArray(formData.specific_users) ? 
                                                                        formData.specific_users.includes(student.user_id.toString()) : 
                                                                        formData.specific_users === student.user_id.toString()) ? 
                                                                        'checked' : '' %>
                                                                <% } else if (announcement.target_type === 'specific_users' && announcement.recipients) { %>
                                                                    <%= announcement.recipients.some(r => r.user_id == student.user_id) ? 'checked' : '' %>
                                                                <% } %>>
                                                            <label class="form-check-label" for="student-<%= student.user_id %>">
                                                                <%= student.first_name %> <%= student.last_name %> (<%= student.email %>)
                                                            </label>
                                                        </div>
                                                    <% }); %>
                                                <% } else { %>
                                                    <p class="text-muted">No students found</p>
                                                <% } %>
                                            </div>
                                        </div>
                                        <div class="card-footer">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" id="selectAllStudents">
                                                <label class="form-check-label" for="selectAllStudents">
                                                    Select/Unselect All Students
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Select Instructors</h6>
                                        </div>
                                        <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                            <div class="mb-2">
                                                <input type="text" class="form-control form-control-sm" id="instructorSearch" placeholder="Search instructors...">
                                            </div>
                                            <div class="instructor-list">
                                                <% if (locals.instructors && instructors.length > 0) { %>
                                                    <% instructors.forEach(instructor => { %>
                                                        <div class="form-check instructor-item">
                                                            <input class="form-check-input instructor-checkbox" type="checkbox" 
                                                                name="specific_users" value="<%= instructor.user_id %>" 
                                                                id="instructor-<%= instructor.user_id %>"
                                                                <% if (locals.formData && formData.specific_users) { %>
                                                                    <%= (Array.isArray(formData.specific_users) ? 
                                                                        formData.specific_users.includes(instructor.user_id.toString()) : 
                                                                        formData.specific_users === instructor.user_id.toString()) ? 
                                                                        'checked' : '' %>
                                                                <% } else if (announcement.target_type === 'specific_users' && announcement.recipients) { %>
                                                                    <%= announcement.recipients.some(r => r.user_id == instructor.user_id) ? 'checked' : '' %>
                                                                <% } %>>
                                                            <label class="form-check-label" for="instructor-<%= instructor.user_id %>">
                                                                <%= instructor.first_name %> <%= instructor.last_name %> (<%= instructor.email %>)
                                                            </label>
                                                        </div>
                                                    <% }); %>
                                                <% } else { %>
                                                    <p class="text-muted">No instructors found</p>
                                                <% } %>
                                            </div>
                                        </div>
                                        <div class="card-footer">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" id="selectAllInstructors">
                                                <label class="form-check-label" for="selectAllInstructors">
                                                    Select/Unselect All Instructors
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="is_active" class="form-label">Status</label>
                            <select class="form-select" id="is_active" name="is_active" required>
                                <option value="true" <%= (locals.formData ? formData.is_active === 'true' : announcement.is_active) ? 'selected' : '' %>>Active</option>
                                <option value="false" <%= (locals.formData ? formData.is_active === 'false' : !announcement.is_active) ? 'selected' : '' %>>Inactive</option>
                            </select>
                        </div>

                        <div class="d-flex mt-4">
                            <button type="submit" class="btn btn-primary me-2">Update Announcement</button>
                            <a href="/admin/announcements" class="btn btn-secondary me-2">Cancel</a>
                            <button type="button" class="btn btn-danger ms-auto"
                                onclick="confirmDelete('/admin/announcements/delete/<%= announcement.announcement_id %>')">
                                <i class="fas fa-trash me-1"></i> Delete Announcement
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Announcement Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this announcement? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="POST">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const targetTypeSelect = document.getElementById('target_type');
        const courseSelection = document.getElementById('course-selection');
        const specificUsersSelection = document.getElementById('specific-users-selection');
        const isActiveYes = document.getElementById('is-active-yes');
        
        // Select all checkboxes
        const selectAllStudents = document.getElementById('selectAllStudents');
        const selectAllInstructors = document.getElementById('selectAllInstructors');
        const studentCheckboxes = document.querySelectorAll('.student-checkbox');
        const instructorCheckboxes = document.querySelectorAll('.instructor-checkbox');
        
        // Search functionality
        const studentSearch = document.getElementById('studentSearch');
        const instructorSearch = document.getElementById('instructorSearch');
        const studentItems = document.querySelectorAll('.student-item');
        const instructorItems = document.querySelectorAll('.instructor-item');
        
        function updateSelections() {
            if (targetTypeSelect.value === 'course') {
                courseSelection.style.display = 'block';
                specificUsersSelection.style.display = 'none';
                document.getElementById('course_id').setAttribute('required', 'required');
            } else if (targetTypeSelect.value === 'specific_users') {
                courseSelection.style.display = 'none';
                specificUsersSelection.style.display = 'block';
                document.getElementById('course_id').removeAttribute('required');
            } else {
                courseSelection.style.display = 'none';
                specificUsersSelection.style.display = 'none';
                document.getElementById('course_id').removeAttribute('required');
            }
        }
        
        // Initial update
        updateSelections();
        
        // Update whenever selection changes
        targetTypeSelect.addEventListener('change', updateSelections);
        
        // Select/deselect all students
        selectAllStudents.addEventListener('change', function() {
            studentCheckboxes.forEach(checkbox => {
                const parentItem = checkbox.closest('.student-item');
                if (parentItem.style.display !== 'none') {
                    checkbox.checked = this.checked;
                }
            });
        });
        
        // Select/deselect all instructors
        selectAllInstructors.addEventListener('change', function() {
            instructorCheckboxes.forEach(checkbox => {
                const parentItem = checkbox.closest('.instructor-item');
                if (parentItem.style.display !== 'none') {
                    checkbox.checked = this.checked;
                }
            });
        });
        
        // Student search functionality
        studentSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            let hasVisibleItems = false;
            
            studentItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = '';
                    hasVisibleItems = true;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Update "select all" checkbox state
            if (!hasVisibleItems) {
                selectAllStudents.disabled = true;
            } else {
                selectAllStudents.disabled = false;
            }
        });
        
        // Instructor search functionality
        instructorSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            let hasVisibleItems = false;
            
            instructorItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = '';
                    hasVisibleItems = true;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Update "select all" checkbox state
            if (!hasVisibleItems) {
                selectAllInstructors.disabled = true;
            } else {
                selectAllInstructors.disabled = false;
            }
        });
        
        // Set active status based on announcement
        if (!isActiveYes.checked && !document.getElementById('is-active-no').checked) {
            const isActive = '<%= announcement.is_active %>' === 'true';
            if (isActive) {
                isActiveYes.checked = true;
            } else {
                document.getElementById('is-active-no').checked = true;
            }
        }
    });
    
    function confirmDelete(url) {
        document.getElementById('deleteForm').action = url;
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }
</script> 