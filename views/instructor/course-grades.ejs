<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h2><%= course.course_name %> - Grade Management</h2>
            <p class="text-muted">Semester: <%= course.semester_name %></p>
        </div>
    </div>

    <!-- Grade Weights Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Grade Weights</h5>
        </div>
        <div class="card-body">
            <form id="weightsForm" class="row g-3">
                <div class="col-md-3">
                    <label for="quiz_weight" class="form-label">Quiz Weight (%)</label>
                    <input type="number" class="form-control" id="quiz_weight" name="quiz_weight" 
                           value="<%= weights.quiz_weight %>" min="0" max="100" required>
                </div>
                <div class="col-md-3">
                    <label for="assignment_weight" class="form-label">Assignment Weight (%)</label>
                    <input type="number" class="form-control" id="assignment_weight" name="assignment_weight" 
                           value="<%= weights.assignment_weight %>" min="0" max="100" required>
                </div>
                <div class="col-md-3">
                    <label for="midterm_weight" class="form-label">Midterm Weight (%)</label>
                    <input type="number" class="form-control" id="midterm_weight" name="midterm_weight" 
                           value="<%= weights.midterm_weight %>" min="0" max="100" required>
                </div>
                <div class="col-md-3">
                    <label for="final_weight" class="form-label">Final Weight (%)</label>
                    <input type="number" class="form-control" id="final_weight" name="final_weight" 
                           value="<%= weights.final_weight %>" min="0" max="100" required>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">Update Weights</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Students and Grades Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Student Grades</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Quiz Score</th>
                            <th>Assignment Score</th>
                            <th>Midterm Score</th>
                            <th>Final Score</th>
                            <th>Total Score</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% students.forEach(student => { %>
                            <tr>
                                <td><%= student.student_name %></td>
                                <td>
                                    <% if (student.quiz_score !== null) { %>
                                        <%= student.quiz_score.toFixed(2) %>%
                                    <% } else { %>
                                        <span class="text-muted">No quizzes completed</span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (student.assignment_score !== null) { %>
                                        <%= student.assignment_score.toFixed(2) %>%
                                    <% } else { %>
                                        <span class="text-muted">No assignments graded</span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (student.midterm_score !== null) { %>
                                        <%= student.midterm_score.toFixed(2) %>%
                                    <% } else { %>
                                        <span class="text-muted">Not taken</span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (student.final_score !== null) { %>
                                        <%= student.final_score.toFixed(2) %>%
                                    <% } else { %>
                                        <span class="text-muted">Not taken</span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (student.total_score !== null) { %>
                                        <strong><%= student.total_score.toFixed(2) %>%</strong>
                                    <% } else { %>
                                        <span class="text-muted">No grades yet</span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (student.grade_status === 'pending') { %>
                                        <span class="badge bg-warning">Pending Review</span>
                                    <% } else if (student.grade_status === 'approved') { %>
                                        <span class="badge bg-success">Approved</span>
                                    <% } else { %>
                                        <span class="badge bg-secondary">In Progress</span>
                                    <% } %>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary edit-grades" 
                                            data-student-id="<%= student.user_id %>"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#editGradesModal">
                                        Edit Grades
                                    </button>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Edit Grades Modal -->
<div class="modal fade" id="editGradesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Student Grades</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editGradesForm">
                    <input type="hidden" id="studentId" name="studentId">
                    <div class="mb-3">
                        <label for="quiz_score" class="form-label">Quiz Score</label>
                        <input type="number" class="form-control" id="quiz_score" name="quiz_score" 
                               min="0" max="100" step="0.01">
                    </div>
                    <div class="mb-3">
                        <label for="assignment_score" class="form-label">Assignment Score</label>
                        <input type="number" class="form-control" id="assignment_score" name="assignment_score" 
                               min="0" max="100" step="0.01">
                    </div>
                    <div class="mb-3">
                        <label for="midterm_score" class="form-label">Midterm Score</label>
                        <input type="number" class="form-control" id="midterm_score" name="midterm_score" 
                               min="0" max="100" step="0.01">
                    </div>
                    <div class="mb-3">
                        <label for="final_score" class="form-label">Final Score</label>
                        <input type="number" class="form-control" id="final_score" name="final_score" 
                               min="0" max="100" step="0.01">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveGrades">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle weights form submission
    const weightsForm = document.getElementById('weightsForm');
    weightsForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(weightsForm);
        const weights = Object.fromEntries(formData.entries());
        
        // Validate total equals 100
        const total = Object.values(weights).reduce((sum, val) => sum + parseFloat(val), 0);
        if (Math.abs(total - 100) > 0.01) {
            alert('Total weight must equal 100%');
            return;
        }

        try {
            const response = await fetch(`/instructor/courses/<%= course.course_id %>/weights`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(weights)
            });

            const data = await response.json();
            if (data.success) {
                alert('Grade weights updated successfully');
                location.reload();
            } else {
                alert(data.error || 'Failed to update weights');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while updating weights');
        }
    });

    // Handle edit grades modal
    const editGradesModal = document.getElementById('editGradesModal');
    const editGradesForm = document.getElementById('editGradesForm');
    const saveGradesBtn = document.getElementById('saveGrades');

    document.querySelectorAll('.edit-grades').forEach(button => {
        button.addEventListener('click', function() {
            const studentId = this.dataset.studentId;
            const row = this.closest('tr');
            
            document.getElementById('studentId').value = studentId;
            document.getElementById('quiz_score').value = row.cells[1].textContent === 'N/A' ? '' : row.cells[1].textContent;
            document.getElementById('assignment_score').value = row.cells[2].textContent === 'N/A' ? '' : row.cells[2].textContent;
            document.getElementById('midterm_score').value = row.cells[3].textContent === 'N/A' ? '' : row.cells[3].textContent;
            document.getElementById('final_score').value = row.cells[4].textContent === 'N/A' ? '' : row.cells[4].textContent;
        });
    });

    saveGradesBtn.addEventListener('click', async function() {
        const formData = new FormData(editGradesForm);
        const grades = Object.fromEntries(formData.entries());
        
        try {
            const response = await fetch(`/instructor/courses/<%= course.course_id %>/grades/${grades.studentId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(grades)
            });

            const data = await response.json();
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Failed to update grades');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while updating grades');
        }
    });
});
</script>