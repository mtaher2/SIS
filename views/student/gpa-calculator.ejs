<!-- GPA Calculator -->
<div class="gpa-calculator">
    <!-- Page Header -->
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h1 class="dashboard-heading">
                <i class="fas fa-calculator me-2"></i> GPA Calculator
            </h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="/student/dashboard">Dashboard</a></li>
                    <li class="breadcrumb-item active">GPA Calculator</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <!-- Current GPA Info -->
        <div class="col-md-4 mb-4">
            <div class="card student-profile-summary">
                <div class="card-body text-center">
                    <h4>Current GPA</h4>
                    <div class="student-gpa"><%= currentGpa ? currentGpa.toFixed(2) : '0.00' %></div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <h5>Current</h5>
                            <p class="text-muted">Current GPA</p>
                        </div>
                        <div class="col-6">
                            <h5 id="estimatedGpaDisplay">-</h5>
                            <p class="text-muted">Estimated GPA</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GPA Calculator Form -->
        <div class="col-md-8 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Estimate Your Future GPA</h5>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary btn-sm" id="addCourse">
                            <i class="fas fa-plus-circle"></i> Add Course
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" id="resetForm">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Current GPA Input -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="currentGPA">Current Cumulative GPA</label>
                                <input type="number" class="form-control" id="currentGPA" min="0" max="4" step="0.01" value="<%= currentGpa || 0 %>" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="totalCreditHours">Total Credit Hours (taken for GPA)</label>
                                <input type="number" class="form-control" id="totalCreditHours" min="0" max="999" value="<%= totalCredits || 0 %>" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Course Inputs -->
                    <div id="courseInputs">
                        <% if(currentCourses && currentCourses.length > 0) { %>
                            <% currentCourses.forEach((course, index) => { %>
                                <div class="row mb-3 course-input" data-course-id="<%= course.course_id %>">
                                    <div class="col-md-5">
                                        <div class="form-group">
                                            <label>Course</label>
                                            <input type="text" class="form-control course-name" value="<%= course.title %> (<%= course.course_code %>)" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label>Credits</label>
                                            <input type="number" class="form-control credit-hours" min="1" max="5" value="<%= course.credit_hours %>" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label>Expected Grade</label>
                                            <select class="form-control expected-grade">
                                                <option value="4.0">A / A+</option>
                                                <option value="3.7">A-</option>
                                                <option value="3.3">B+</option>
                                                <option value="3.0">B</option>
                                                <option value="2.7">B-</option>
                                                <option value="2.3">C+</option>
                                                <option value="2.0">C</option>
                                                <option value="1.7">C-</option>
                                                <option value="1.3">D+</option>
                                                <option value="1.0">D</option>
                                                <option value="0.0">F</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label>Exclude Course</label>
                                            <div class="form-check">
                                                <input class="form-check-input exclude-course" type="checkbox" id="excludeCourse">
                                                <label class="form-check-label" for="excludeCourse">
                                                    Exclude from GPA
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label>Previous Grade</label>
                                            <select class="form-control previous-grade" disabled>
                                                <option value="4.0">A / A+</option>
                                                <option value="3.7">A-</option>
                                                <option value="3.3">B+</option>
                                                <option value="3.0">B</option>
                                                <option value="2.7">B-</option>
                                                <option value="2.3">C+</option>
                                                <option value="2.0">C</option>
                                                <option value="1.7">C-</option>
                                                <option value="1.3">D+</option>
                                                <option value="1.0">D</option>
                                                <option value="0.0">F</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-1 d-flex align-items-end">
                                        <button type="button" class="btn btn-danger btn-sm remove-course">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <div class="alert alert-info">
                                No current courses found. Add courses to calculate your estimated GPA.
                            </div>
                        <% } %>
                    </div>
                    
                    <div class="d-grid gap-2 mt-3">
                        <button type="button" id="calculateGPA" class="btn btn-primary" <%= (!currentCourses || currentCourses.length === 0) ? 'disabled' : '' %>>
                            <i class="fas fa-calculator me-2"></i> Calculate GPA
                        </button>
                    </div>
                    
                    <div id="gpaError" class="alert alert-danger mt-3" style="display: none;"></div>
                    
                    <!-- Results Section -->
                    <div id="gpaResults" class="mt-4" style="display: none;">
                        <h4 class="border-bottom pb-2">Projected GPA</h4>
                        <div class="table-responsive">
                            <table class="table table-bordered" style="width: 100%; min-width: 800px;">
                                <thead>
                                    <tr>
                                        <th style="width: 25%;">Projected Semester GPA</th>
                                        <th style="width: 25%;">Credit Hours this Semester</th>
                                        <th style="width: 25%;">Projected Overall GPA</th>
                                        <th style="width: 25%;">Total Credit Hours</th>
                                    </tr>
                                </thead>
                                <tbody id="gpaResultsBody">
                                    <!-- Results will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Goal GPA Calculator -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Goal GPA Calculator</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="goalCurrentGPA">Current Cumulative GPA</label>
                                <input type="number" class="form-control" id="goalCurrentGPA" min="0" max="4" step="0.01" value="<%= currentGpa || 0 %>" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="goalTotalHours">Total Credit Hours (taken for GPA)</label>
                                <input type="number" class="form-control" id="goalTotalHours" min="0" max="999" value="<%= totalCredits || 0 %>" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="targetGPA">Goal Overall GPA</label>
                                <input type="number" class="form-control" id="targetGPA" min="0" max="4" step="0.01" value="3.0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="plannedCreditHours">Credit Hours this Semester</label>
                                <input type="number" class="form-control" id="plannedCreditHours" min="0" max="999" value="12">
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="button" id="calculateGoalGPA" class="btn btn-primary">
                            <i class="fas fa-bullseye me-2"></i> Calculate Required GPA
                        </button>
                    </div>
                    
                    <div id="goalGpaError" class="alert alert-danger mt-3" style="display: none;"></div>
                    <div id="goalGpaResult" class="alert alert-info mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- GPA Info Card -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">GPA Scale Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Letter Grade to GPA Conversion</h6>
                            <table class="table table-bordered" style="width: 100%; min-width: 400px;">
                                <thead>
                                    <tr>
                                        <th style="width: 33%;">Letter Grade</th>
                                        <th style="width: 33%;">Percentage</th>
                                        <th style="width: 33%;">GPA Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td>A</td><td>90-100%</td><td>4.0</td></tr>
                                    <tr><td>A-</td><td>87-89%</td><td>3.7</td></tr>
                                    <tr><td>B+</td><td>84-86%</td><td>3.3</td></tr>
                                    <tr><td>B</td><td>80-83%</td><td>3.0</td></tr>
                                    <tr><td>B-</td><td>77-79%</td><td>2.7</td></tr>
                                    <tr><td>C+</td><td>74-76%</td><td>2.3</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>&nbsp;</h6>
                            <table class="table table-bordered" style="width: 100%; min-width: 400px;">
                                <thead>
                                    <tr>
                                        <th style="width: 33%;">Letter Grade</th>
                                        <th style="width: 33%;">Percentage</th>
                                        <th style="width: 33%;">GPA Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td>C</td><td>70-73%</td><td>2.0</td></tr>
                                    <tr><td>C-</td><td>67-69%</td><td>1.7</td></tr>
                                    <tr><td>D+</td><td>64-66%</td><td>1.3</td></tr>
                                    <tr><td>D</td><td>60-63%</td><td>1.0</td></tr>
                                    <tr><td>F</td><td>0-59%</td><td>0.0</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const calculateBtn = document.getElementById('calculateGPA');
        const resetBtn = document.getElementById('resetForm');
        const addCourseBtn = document.getElementById('calculateGoalGPA');
        const gpaResults = document.getElementById('gpaResults');
        const gpaError = document.getElementById('gpaError');
        const courseInputs = document.getElementById('courseInputs');
        
        // Add course
        document.getElementById('addCourse').addEventListener('click', function() {
            const courseInput = document.createElement('div');
            courseInput.className = 'row mb-3 course-input';
            courseInput.innerHTML = `
                <div class="col-md-5">
                    <div class="form-group">
                        <label>Course</label>
                        <input type="text" class="form-control course-name" placeholder="Enter course name">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Credits</label>
                        <input type="number" class="form-control credit-hours" min="1" max="5" value="3">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Expected Grade</label>
                        <select class="form-control expected-grade">
                            <option value="4.0">A / A+</option>
                            <option value="3.7">A-</option>
                            <option value="3.3">B+</option>
                            <option value="3.0">B</option>
                            <option value="2.7">B-</option>
                            <option value="2.3">C+</option>
                            <option value="2.0">C</option>
                            <option value="1.7">C-</option>
                            <option value="1.3">D+</option>
                            <option value="1.0">D</option>
                            <option value="0.0">F</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label>Exclude Course</label>
                        <div class="form-check">
                            <input class="form-check-input exclude-course" type="checkbox" id="excludeCourse">
                            <label class="form-check-label" for="excludeCourse">
                                Exclude from GPA
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label>Previous Grade</label>
                        <select class="form-control previous-grade" disabled>
                            <option value="4.0">A / A+</option>
                            <option value="3.7">A-</option>
                            <option value="3.3">B+</option>
                            <option value="3.0">B</option>
                            <option value="2.7">B-</option>
                            <option value="2.3">C+</option>
                            <option value="2.0">C</option>
                            <option value="1.7">C-</option>
                            <option value="1.3">D+</option>
                            <option value="1.0">D</option>
                            <option value="0.0">F</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-danger btn-sm remove-course">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            courseInputs.appendChild(courseInput);
            calculateBtn.disabled = false;
        });
        
        // Remove course
        courseInputs.addEventListener('click', function(e) {
            if (e.target.closest('.remove-course')) {
                const courseInput = e.target.closest('.course-input');
                courseInput.remove();
                
                // Disable calculate button if no courses left
                if (document.querySelectorAll('.course-input').length === 0) {
                    calculateBtn.disabled = true;
                }
            }
        });
        
        // Handle exclude course checkbox
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('exclude-course')) {
                const courseInput = e.target.closest('.course-input');
                const previousGradeSelect = courseInput.querySelector('.previous-grade');
                previousGradeSelect.disabled = !e.target.checked;
            }
        });
        
        // Calculate GPA
        calculateBtn.addEventListener('click', function() {
            const currentGPA = parseFloat(document.getElementById('currentGPA').value) || 0;
            const totalCredits = parseInt(document.getElementById('totalCreditHours').value) || 0;
            const courseInputs = document.querySelectorAll('.course-input');
            
            let semesterPoints = 0;
            let semesterCredits = 0;
            let excludedPoints = 0;
            let excludedCredits = 0;
            
            courseInputs.forEach(input => {
                const credits = parseInt(input.querySelector('.credit-hours').value);
                const grade = parseFloat(input.querySelector('.expected-grade').value);
                const isExcluded = input.querySelector('.exclude-course').checked;
                const previousGrade = parseFloat(input.querySelector('.previous-grade').value) || 0;
                
                if (isExcluded) {
                    excludedPoints += previousGrade * credits;
                    excludedCredits += credits;
                } else {
                    semesterPoints += grade * credits;
                    semesterCredits += credits;
                }
            });
            
            if (semesterCredits === 0) {
                gpaError.textContent = 'Please add at least one course to calculate GPA';
                gpaError.style.display = 'block';
                gpaResults.style.display = 'none';
                return;
            }
            
            // Calculate new GPA excluding the specified courses
            const totalPoints = (currentGPA * totalCredits) - excludedPoints + semesterPoints;
            const newTotalCredits = totalCredits - excludedCredits + semesterCredits;
            const projectedGPA = totalPoints / newTotalCredits;
            
            // Update estimated GPA display
            document.getElementById('estimatedGpaDisplay').textContent = projectedGPA.toFixed(2);
            
            // Display results
            const resultsBody = document.getElementById('gpaResultsBody');
            resultsBody.innerHTML = `
                <tr>
                    <td>${(semesterPoints / semesterCredits).toFixed(2)}</td>
                    <td>${semesterCredits}</td>
                    <td>${projectedGPA.toFixed(2)}</td>
                    <td>${newTotalCredits}</td>
                </tr>
            `;
            
            gpaResults.style.display = 'block';
            gpaError.style.display = 'none';
        });
        
        // Calculate Goal GPA
        document.getElementById('calculateGoalGPA').addEventListener('click', function() {
            const currentGPA = parseFloat(document.getElementById('goalCurrentGPA').value) || 0;
            const totalCredits = parseInt(document.getElementById('goalTotalHours').value) || 0;
            const targetGPA = parseFloat(document.getElementById('targetGPA').value) || 0;
            const plannedCredits = parseInt(document.getElementById('plannedCreditHours').value) || 0;
            
            const goalGpaError = document.getElementById('goalGpaError');
            const goalGpaResult = document.getElementById('goalGpaResult');
            
            if (plannedCredits === 0) {
                goalGpaError.textContent = 'Please enter planned credit hours';
                goalGpaError.style.display = 'block';
                goalGpaResult.style.display = 'none';
                return;
            }
            
            // Calculate required GPA
            const currentPoints = currentGPA * totalCredits;
            const targetPoints = targetGPA * (totalCredits + plannedCredits);
            const requiredPoints = targetPoints - currentPoints;
            const requiredGPA = requiredPoints / plannedCredits;
            
            if (requiredGPA > 4.0) {
                goalGpaError.textContent = 'Goal GPA is not achievable with the current credit hours';
                goalGpaError.style.display = 'block';
                goalGpaResult.style.display = 'none';
            } else if (requiredGPA < 0) {
                goalGpaError.textContent = 'Goal GPA is already achieved';
                goalGpaError.style.display = 'block';
                goalGpaResult.style.display = 'none';
            } else {
                goalGpaResult.innerHTML = `
                    <strong>Required Semester GPA:</strong> ${requiredGPA.toFixed(2)}<br>
                    <strong>Required Letter Grade:</strong> ${getLetterGrade(requiredGPA)}
                `;
                goalGpaResult.style.display = 'block';
                goalGpaError.style.display = 'none';
            }
        });
        
        // Reset form
        resetBtn.addEventListener('click', function() {
            const gradeSelects = document.querySelectorAll('.expected-grade');
            gradeSelects.forEach(select => {
                select.value = '4.0'; // Reset to A
            });
            
            gpaResults.style.display = 'none';
            gpaError.style.display = 'none';
            document.getElementById('estimatedGpaDisplay').textContent = '-';
        });
        
        // Helper function to get letter grade
        function getLetterGrade(gpa) {
            if (gpa >= 3.7) return 'A- or higher';
            if (gpa >= 3.3) return 'B+ or higher';
            if (gpa >= 3.0) return 'B or higher';
            if (gpa >= 2.7) return 'B- or higher';
            if (gpa >= 2.3) return 'C+ or higher';
            if (gpa >= 2.0) return 'C or higher';
            if (gpa >= 1.7) return 'C- or higher';
            if (gpa >= 1.3) return 'D+ or higher';
            if (gpa >= 1.0) return 'D or higher';
            return 'F';
        }
    });
</script> 
