<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="mb-2">My Attendance</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="/student/dashboard">Dashboard</a></li>
                    <li class="breadcrumb-item active">Attendance</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card mb-4">
        <div class="card-body">
            <form action="/student/attendance" method="GET" class="row g-3">
                <div class="col-md-6">
                    <label for="course_id" class="form-label">Course</label>
                    <select class="form-select" id="course_id" name="course_id">
                        <option value="">All Courses</option>
                        <% if (courses && courses.length > 0) { %>
                            <% courses.forEach(course => { %>
                                <option value="<%= course.course_id %>" <%= selectedCourse == course.course_id ? 'selected' : '' %>>
                                    <%= course.course_code %> - <%= course.title %>
                                </option>
                            <% }); %>
                        <% } %>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="month" class="form-label">Month</label>
                    <select class="form-select" id="month" name="month">
                        <option value="">All Months</option>
                        <% 
                            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                                           'July', 'August', 'September', 'October', 'November', 'December'];
                            
                            const currentMonth = new Date().getMonth();
                            
                            months.forEach((month, index) => {
                        %>
                            <option value="<%= index + 1 %>" <%= locals.month == index + 1 ? 'selected' : (locals.month === undefined && index === currentMonth ? 'selected' : '') %>>
                                <%= month %>
                            </option>
                        <% }); %>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Filter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Attendance Statistics -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <% 
                        // Calculate overall attendance rate
                        let totalClasses = 0;
                        let presentClasses = 0;
                        
                        if (attendance && attendance.length > 0) {
                            totalClasses = attendance.length;
                            attendance.forEach(record => {
                                if (record.status === 'present') {
                                    presentClasses++;
                                }
                            });
                        }
                        
                        const attendanceRate = totalClasses > 0 ? Math.round((presentClasses / totalClasses) * 100) : 0;
                    %>
                    <div class="attendance-circle" style="--percentage: <%= attendanceRate %>%">
                        <div class="attendance-circle-inner">
                            <span class="attendance-percentage"><%= attendanceRate %>%</span>
                        </div>
                    </div>
                    <h5 class="mt-3 mb-0">Overall Attendance</h5>
                    <p class="text-muted">
                        <%= presentClasses %> of <%= totalClasses %> classes attended
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Attendance Summary</h5>
                    
                    <% 
                        // Group by status
                        const statusCounts = {
                            present: 0,
                            absent: 0,
                            late: 0,
                            excused: 0
                        };
                        
                        if (attendance && attendance.length > 0) {
                            attendance.forEach(record => {
                                if (statusCounts[record.status] !== undefined) {
                                    statusCounts[record.status]++;
                                }
                            });
                        }
                    %>
                    
                    <div class="row g-3 mt-2">
                        <div class="col-md-6 col-lg-3">
                            <div class="attendance-stat">
                                <div class="attendance-stat-icon bg-success-subtle">
                                    <i class="fas fa-check-circle text-success"></i>
                                </div>
                                <div class="attendance-stat-info">
                                    <h3 class="mb-0"><%= statusCounts.present %></h3>
                                    <p class="mb-0 text-muted">Present</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <div class="attendance-stat">
                                <div class="attendance-stat-icon bg-danger-subtle">
                                    <i class="fas fa-times-circle text-danger"></i>
                                </div>
                                <div class="attendance-stat-info">
                                    <h3 class="mb-0"><%= statusCounts.absent %></h3>
                                    <p class="mb-0 text-muted">Absent</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <div class="attendance-stat">
                                <div class="attendance-stat-icon bg-warning-subtle">
                                    <i class="fas fa-clock text-warning"></i>
                                </div>
                                <div class="attendance-stat-info">
                                    <h3 class="mb-0"><%= statusCounts.late %></h3>
                                    <p class="mb-0 text-muted">Late</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <div class="attendance-stat">
                                <div class="attendance-stat-icon bg-info-subtle">
                                    <i class="fas fa-notes-medical text-info"></i>
                                </div>
                                <div class="attendance-stat-info">
                                    <h3 class="mb-0"><%= statusCounts.excused %></h3>
                                    <p class="mb-0 text-muted">Excused</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <% if (selectedCourse && courses && courses.length > 0) { 
                        const selectedCourseData = courses.find(c => c.course_id == selectedCourse);
                        if (selectedCourseData) {
                    %>
                        <div class="alert alert-info mt-3 mb-0">
                            <strong>Note:</strong> <%= selectedCourseData.title %> requires a minimum attendance of 75% to qualify for the final exam.
                        </div>
                    <% }} %>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Records -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Attendance Records</h5>
        </div>
        <div class="card-body">
            <% if (attendance && attendance.length > 0) { %>
                <div class="table-responsive">
                    <table class="table table-hover attendance-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Course</th>
                                <th>Status</th>
                                <th>Time</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% attendance.forEach(record => { 
                                const classDate = new Date(record.class_date);
                                
                                let statusClass = '';
                                let statusIcon = '';
                                
                                switch(record.status) {
                                    case 'present':
                                        statusClass = 'bg-success';
                                        statusIcon = 'fas fa-check';
                                        break;
                                    case 'absent':
                                        statusClass = 'bg-danger';
                                        statusIcon = 'fas fa-times';
                                        break;
                                    case 'late':
                                        statusClass = 'bg-warning';
                                        statusIcon = 'fas fa-clock';
                                        break;
                                    case 'excused':
                                        statusClass = 'bg-info';
                                        statusIcon = 'fas fa-notes-medical';
                                        break;
                                    default:
                                        statusClass = 'bg-secondary';
                                        statusIcon = 'fas fa-question';
                                }
                            %>
                                <tr>
                                    <td>
                                        <%= classDate.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' }) %>
                                    </td>
                                    <td>
                                        <a href="/student/courses/<%= record.course_id %>">
                                            <%= record.course_code %> - <%= record.course_title %>
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge <%= statusClass %>">
                                            <i class="<%= statusIcon %> me-1"></i>
                                            <%= record.status.charAt(0).toUpperCase() + record.status.slice(1) %>
                                        </span>
                                    </td>
                                    <td>
                                        <% if (record.check_in_time) { %>
                                            <span data-bs-toggle="tooltip" data-bs-placement="top" title="Check-in time">
                                                <i class="fas fa-sign-in-alt text-success me-1"></i>
                                                <%= new Date(record.check_in_time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %>
                                            </span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <% if (record.notes) { %>
                                            <span data-bs-toggle="tooltip" data-bs-placement="top" title="<%= record.notes %>">
                                                <i class="fas fa-comment-alt text-muted me-1"></i>
                                                <%= record.notes.length > 30 ? record.notes.substring(0, 30) + '...' : record.notes %>
                                            </span>
                                        <% } %>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            <% } else { %>
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i> No attendance records found. Please select a different course or time period.
                </div>
            <% } %>
        </div>
    </div>
</div>

<style>
    /* Attendance circle */
    .attendance-circle {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: conic-gradient(var(--bs-success) var(--percentage), #e9ecef 0);
        margin: 0 auto;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .attendance-circle-inner {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: white;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .attendance-percentage {
        font-size: 2rem;
        font-weight: bold;
        color: var(--bs-success);
    }
    
    /* Attendance stat cards */
    .attendance-stat {
        display: flex;
        align-items: center;
    }
    
    .attendance-stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-right: 12px;
    }
    
    .attendance-stat-icon i {
        font-size: 1.25rem;
    }
    
    .attendance-stat-info h3 {
        font-size: 1.5rem;
        font-weight: bold;
    }
    
    /* Table styles */
    .attendance-table th {
        background-color: #f8f9fa;
    }
    
    /* Color utility classes */
    .bg-success-subtle {
        background-color: rgba(25, 135, 84, 0.15);
    }
    
    .bg-danger-subtle {
        background-color: rgba(220, 53, 69, 0.15);
    }
    
    .bg-warning-subtle {
        background-color: rgba(255, 193, 7, 0.15);
    }
    
    .bg-info-subtle {
        background-color: rgba(13, 202, 240, 0.15);
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .attendance-circle {
            width: 120px;
            height: 120px;
        }
        
        .attendance-circle-inner {
            width: 90px;
            height: 90px;
        }
        
        .attendance-percentage {
            font-size: 1.5rem;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Auto-submit form when course or month changes
        document.getElementById('course_id').addEventListener('change', function() {
            document.querySelector('form').submit();
        });
        
        document.getElementById('month').addEventListener('change', function() {
            document.querySelector('form').submit();
        });
    });
</script> 